---
- name: Import API token
  include_vars: secrets.yml

- name: Clone cloud-init template
  community.general.proxmox_kvm:
    node: opti-hst-03 # Where the cloud-init template is
    target: opti-hst-01
    vmid: 9000 #VM ID of the template
    clone: ubuntu-template # Name of VM to be cloned. If vmid is set, clone can take an arbitrary value but is required for initiating the clone.
    name: ansible-deploy-test
    storage: ceph-pool-01
    memory: 8192
    net: '{"net0":"virtio,bridge=vmbr0,tag=7"}' # NOT WORKING
     
    #ipconfig: ipconfig0='{ip="10.0.7.251/24",gw="10.0.7.1"}'
    #state: present

    api_user: root@pam
    api_token_id: "{{ proxmox_token_id }}"
    api_token_secret: "{{ proxmox_token_secret }}"
    api_host: 10.0.7.6
    timeout: 90

- name: Start VM 
  community.general.proxmox_kvm:
    node: opti-hst-03
    name: ansible-deploy-test
    api_user: root@pam
    api_token_id: "{{ proxmox_token_id }}"
    api_token_secret: "{{ proxmox_token_secret }}"
    api_host: 10.0.7.6
    state: started