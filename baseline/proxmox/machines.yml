---
- name: Import API token
  include_vars: secrets.yml

- name: Create VM
  community.general.proxmox_kvm:
    # Credentials and host/node to work from
    node: opti-hst-03
    api_user: root@pam
    api_token_id: "{{ proxmox_token_id }}"
    api_token_secret: "{{ proxmox_token_secret }}"
    api_host: 10.0.7.8

    # Basic VM info
    vmid: 105
    name: cloud-test
    ostype: l26 # See https://docs.ansible.com/ansible/latest/collections/community/general/proxmox_kvm_module.html
    
    # Hardware info
    memory: 8192
    cores: 2
    scsihw: virtio-scsi-pci
    ide:
      ide2: 'ceph-pool-01:cloudinit,format=qcow2'
    serial: 
      serial0: socket
    vga: serial0
    boot: order=scsi0;ide2
    
    # Storage and network info
    net:
      net0: 'virtio,bridge=vmbr0,tag=7'
    ipconfig:
      ipconfig0: 'ip=10.0.7.251/24,gw=10.0.7.1'
    nameservers: 10.0.30.75
    
    # Cloud-init info
    ciuser: josh
    cipassword: "{{ cipassword }}"
    sshkeys: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"
    
    # Desired state
    state: present

- name: Import cloud-init disk
  community.general.proxmox_disk:
    api_user: root@pam
    api_token_id: "{{ proxmox_token_id }}"
    api_token_secret: "{{ proxmox_token_secret }}"
    api_host: 10.0.7.8  
    vmid: 105
    disk: scsi0
    import_from: ceph-pool-01:base-9000-disk-0
    storage: ceph-pool-01
    state: present

- name: Start VM 
  community.general.proxmox_kvm:
    vmid: 105    
    api_user: root@pam
    api_token_id: "{{ proxmox_token_id }}"
    api_token_secret: "{{ proxmox_token_secret }}"
    api_host: 10.0.7.8
    state: started
